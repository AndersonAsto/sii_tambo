{% extends 'admin_index.html' %}
{% block title %}Ventas - Tambo{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2 class="fw-bold mb-4 text-dark">Ventas Registradas</h2>

    <!-- =========================
            FILTROS
    ========================== -->
    <form method="GET" action="{{ url_for('totalsales.index') }}" class="row g-3 mb-4">

        <div class="col-md-4">
            <select id="departamento" name="departamento" class="form-select">
                <option value="">Todos los departamentos</option>
                {% for d in departamentos %}
                    <option value="{{ d }}" {% if departamento_sel == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <select id="provincia" name="provincia" class="form-select">
                <option value="">Todas las provincias</option>
            </select>
        </div>

        <div class="col-md-4">
            <select id="distrito" name="distrito" class="form-select">
                <option value="">Todos los distritos</option>
            </select>
        </div>

        <div class="col-md-12">
            <button type="submit" class="btn btn-dark rounded-3">
                <i class="bi bi-funnel"></i> Filtrar
            </button>
        </div>
    </form>

    <a href="{{ url_for('totalsales.reporte_pdf',
        departamento=departamento_sel,
        provincia=provincia_sel,
        distrito=distrito_sel
    ) }}" class="btn btn-danger">
        <i class="fas fa-file-pdf"></i> Exportar PDF
    </a>

    <form action="{{ url_for('totalsales.enviar_alamacen') }}" method="POST" class="mb-3">
    <button class="btn btn-warning" onclick="return confirm('¿Enviar los datos al almacén de datos?');">
        <i class="bi bi-cloud-upload"></i> Enviar datos al almacén
    </button>
</form>
    <!-- =========================
            TABLA
    ========================== -->
    <div class="card shadow-sm rounded-4">
        <div class="card-body p-0">

            <table class="table table-hover mb-0">
                <thead class="table-dark text-white">
                    <tr>
                        <th>ID Venta</th>
                        <th>Tienda</th>
                        <th>Distrito</th>
                        <th>Provincia</th>
                        <th>Departamento</th>
                        <th>Total (S/.)</th>
                        <th>Productos</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for v in ventas.items %}
                    <tr>
                        <td>{{ v.idVenta }}</td>
                        <td>{{ v.tienda.nombreTienda }}</td>
                        <td>{{ v.tienda.distrito }}</td>
                        <td>{{ v.tienda.provincia }}</td>
                        <td>{{ v.tienda.departamento }}</td>

                        <td>S/. {{ "%.2f"|format(v.total) }}</td>
                        <td>{{ v.cantidadProductos }}</td>
                        <td>{{ v.createdAt.strftime("%d/%m/%Y %H:%M") }}</td>

                        <td>
                            <button class="btn btn-purple btn-sm"
                                    onclick="cargarDetalle({{ v.idVenta }})">
                                Ver Detalle
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No se encontraron ventas para los filtros aplicados
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>
    </div>

    <!-- Paginación -->
    <div class="mt-3 text-center">
        {% if ventas.has_prev %}
            <a href="{{ url_for('totalsales.index', page=ventas.prev_num) }}" class="btn btn-purple">⬅ Anterior</a>
        {% endif %}

        <span class="mx-2">Página {{ ventas.page }} de {{ ventas.pages }}</span>

        {% if ventas.has_next %}
            <a href="{{ url_for('totalsales.index', page=ventas.next_num) }}" class="btn btn-purple">Siguiente ➡</a>
        {% endif %}
    </div>
</div>


<!-- =========================
        MODAL
========================= -->
<div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="detalleModalContent">
            <!-- Aquí se carga el contenido AJAX -->
        </div>
    </div>
</div>

<script>
    const depProvDist = {{ dep_prov_dist | tojson }};
    const departamentoSel = "{{ departamento_sel or '' }}";
    const provinciaSel = "{{ provincia_sel or '' }}";
    const distritoSel = "{{ distrito_sel or '' }}";

    const selectDep = document.getElementById("departamento");
    const selectProv = document.getElementById("provincia");
    const selectDist = document.getElementById("distrito");

    // ============================
    //    CARGAR PROVINCIAS
    // ============================
    function cargarProvincias() {
        selectProv.innerHTML = '<option value="">Todas las provincias</option>';
        selectDist.innerHTML = '<option value="">Todos los distritos</option>';

        const dep = selectDep.value;
        if (!dep || !depProvDist[dep]) return;

        Object.keys(depProvDist[dep]).forEach(prov => {
            const opt = new Option(prov, prov);
            if (prov === provinciaSel) opt.selected = true;
            selectProv.add(opt);
        });

        cargarDistritos(); // cargar distritos si ya hay provinciaSel
    }

    // ============================
    //     CARGAR DISTRITOS
    // ============================
    function cargarDistritos() {
        selectDist.innerHTML = '<option value="">Todos los distritos</option>';

        const dep = selectDep.value;
        const prov = selectProv.value;

        if (!dep || !prov || !depProvDist[dep][prov]) return;

        depProvDist[dep][prov].forEach(dist => {
            const opt = new Option(dist, dist);
            if (dist === distritoSel) opt.selected = true;
            selectDist.add(opt);
        });
    }

    // Eventos de cambio
    selectDep.addEventListener("change", cargarProvincias);
    selectProv.addEventListener("change", cargarDistritos);

    // ============================
    //   EJECUTAR AL INICIAR
    // ============================
    if (departamentoSel) {
        selectDep.value = departamentoSel;
        cargarProvincias();
    }
</script>

{% endblock %}
